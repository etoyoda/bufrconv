# BUFRとは
BUFR とは、WMO（世界気象機関）がGTS（全球気象通信網）での国際データ交換に用いるために開発したデータ形式（通報式）のひとつです。
現在 WMO は通報式を GRIB と BUFR に集約する方針ですが、
格子データに特化したGRIBになじまないような時空間構造を持つデータ、
強いて今風に言うならば半構造データを表現するために、BUFR は用いられます。

BUFR は Binary Universal Form for the Representation of meteorological data
の略で、データ構造を問わないという意図を表現した名前です。

以下、一般的な解説に交えて本 bufrconv パッケージの説明をしているところには
米印（※）を付します。

## BUFR の節構造

|節|長さ/オクテット|必須|説明|
|--|----------|----|----|
|0 |8         |必須|マジックナンバー "BUFR"、電文長、版edition番号|
|1 |17以上(第3版), 22以上(第4版)|必須|識別節 identification section|
|2 |可変|**任意**|任意節 optional section （有無は次表参照）|
|3 |可変|必須|資料記述節 data description section (データ構造記述)|
|4 |可変|必須|資料節 data section (データ本体)|
|5 |4   |必須|マジックナンバー "7777" |

BUFR に従うデータ表現は **BUFR 報 (BUFR message)** と呼ばれます。
データサンプルなどでは単独の BUFR 報（"BUFR" から "7777" まで一組）を
独のファイルに保存することもありますが、たいていの実務においては
WMO バッチ FTP 形式などなんらかの形式 (気象庁内でもシステム毎に
異なる) のファイルに多数の BUFR 報が格納されます。

第0節の電文長と第1～4節の冒頭3オクテットは、ビッグエンディアンの整数値で
オクテット数を指示します。データファイルからマジックナンバー "BUFR" を
探索するだけでは他のテキストなどと偶然一致してしまうことが
あるかもしれませんが、第1節から順に節の長さを追って "7777" が見つかる
ならば、正当な BUFR 報の構造と言えるでしょう。

※ bufrscan.rb では特定のファイル形式を仮定せず、マジックナンバー
"BUFR" を探索して節構造を検証することで BUFR 報を漏れなく
探すようにしています。

## BUFR第1節の構造

|※略称|第3版|第4版|説明|
|---|---|---|---|
|―|0-2|0-2|節の長さ|
|:mastab|3|3|マスター表番号（つまり分野番号）|
|:ctr|5|4-5|作成中枢番号|
|:subctr|4|6-7|作成副中枢番号（作成中枢で管理）|
|:upd|6|8|更新一連番号|
|―|7|9|MSBが立っていたら第2節が存在する|
|:cat|8|10|カテゴリ番号|
|:subcat||11|サブカテゴリ番号（国際管理）|
|:subcat|9||サブカテゴリ番号（作成中枢で管理）|
|| |12|サブカテゴリ番号（作成中枢で管理）|
|:masver|10|13|マスター表のバージョン番号|
|:locver|11|14|ローカル表のバージョン番号|
|:reftime||15-16|参照日時（年）|
|↑|12||参照日時（年の下2桁）|
|↑|13|17|参照日時（月）|
|↑|14|18|参照日時（日）|
|↑|15|19|参照日時（時）|
|↑|16|20|参照日時（分）|
|↑||21|参照日時（秒）|

※ bufrscan.rb 内の Bufrdcd#[] にこの略称を与えると解読結果が返ります。

BUFR 第1節はオクテット単位の構造をもち、
どんな通報にも共通のメタデータが入っています。

- 誰が作ったか（:ctr, :subctr）
- データの日時（:reftime） 
- データ種別（:cat, :subcat）
- 更新一連番号 = 訂正数（:upd）
- データ本体解読用の表のバージョン情報（:masver, :locver）

若干おせっかいな説明:

- マスター表番号（分野番号）（:mastab）は
  0: 気象分野 (WMO管理) 10: 海洋分野（UNESCO/IOC管理）
  というように管理主体ごとに名前空間を分けられるように設計されたものですが、
  実際問題 0 以外見たことがありません。
- 作成中枢番号（:ctr）は GRIB と共通です。
  http://codes.wmo.int/common/_centre
  第4版では名前空間が 8 ビットから 16 ビットに拡張されましたが、
  256 以上の値が活用されている例は知りません。
- マスター表のバージョン番号（:masver）は
  14以上と 13 の区別だけ気を付けましょう。
  同じ記述子（後述）でもビット幅が異なるなど酷い非互換性があります。
  バージョン13からバージョン14への改正で大混乱を起こして反省して、
  上位互換の改正しか行われなくなったので、
  14以上の版数は全部最新版 http://codes.wmo.int/bufr4/b とみなしてOKです。
  バージョン12以前にはさらに非互換性があるのですが、
  さいわいリアルタイム通報ではもう見かけません。
- 参照日時 reference time （:reftime）は
  データの種類により色々の使われ方をしています。
  データ本体の日時の最初を取るものもあれば、切り上げているものもあり。
  実務上、2000年問題がめんどくさいです。
  BUFR第3版では常に年に 2000 を加算しなければなりませんし、
  BUFR第4版ですら16ビットの年数欄に年の下二桁が書かれていることがあります。
- 更新一連番号（:upd）は、デフォルトで0、
  同一地点、同一時刻、同一種類の観測で訂正を打つときに1つづつ増やして
  発信します。

もうちょっと評論家的なことをいうと、第1節に記載される情報は、
「データ種別、データの日時、訂正数」としてみると
GTS 電文ヘッダ
https://qiita.com/e_toyoda/items/9893b4386084528f2af5#%E3%83%98%E3%83%83%E3%83%80%E3%81%AE%E6%A7%8B%E9%80%A0
とほぼ同じ情報です。
1980 年代の設計当初何を考えていたのかわかりませんが、
伝送路が GTS から電文ヘッダを用いないものに変わっても、
リアルタイム通報受信処理が影響を受けないで維持できるようになっています。

## データ種別（抜粋）

最新版は通報式の共通符号表 C-13 です。

|カテゴリ|カテゴリ|サブカテゴリ|サブカテゴリ|
|---|---|---|---|
|0|陸上地表|0|固定地点地上観測（毎時）(SYNOP)|
|0|陸上地表|1|固定地点地上観測（中間時）(SYNOP)|
|0|陸上地表|2|固定地点地上観測（主要時）(SYNOP)|
|0|陸上地表|3|移動地上観測（毎時）(SYNOP MOBIL)|
|0|陸上地表|4|移動地上観測（中間時）(SYNOP MOBIL)|
|0|陸上地表|5|移動地上観測（主要時）(SYNOP MOBIL)|
|0|陸上地表|7|地上自動観測（分単位）|
|0|陸上地表|50|固定地点地上観測（毎時）過去1時間の補助データつき(SYNOP)|
|0|陸上地表|51|固定地点地上観測（中間時）過去1時間の補助データつき(SYNOP)|
|0|陸上地表|52|固定地点地上観測（主要時）過去1時間の補助データつき(SYNOP)|
|1|海上海表|0|船舶観測 (SHIP)|
|1|海上海表|25|ブイ観測 (BUOY)|
|2|鉛直サウンディング|1|固定地点高層風観測 (PILOT)|
|2|鉛直サウンディング|2|船上高層風観測 (PILOT SHIP)|
|2|鉛直サウンディング|3|移動高層風観測 (PILOT MOBIL)|
|2|鉛直サウンディング|4|固定地点ラジオゾンデ観測 (TEMP)|
|2|鉛直サウンディング|5|船上ラジオゾンデ観測 (TEMP SHIP)|
|2|鉛直サウンディング|6|移動ラジオゾンデ観測 (TEMP MOBIL)|
|2|鉛直サウンディング|10|ウィンドプロファイラ観測|
|2|鉛直サウンディング|20|航空機観測 (AMDAR)|
|6|レーダー|1|ドップラーウィンドプロファイラ|
